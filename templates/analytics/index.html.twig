{% extends 'base.html.twig' %}

{% block title %}Analytics Trading{% endblock %}

{% block body %}

{% include 'components/compact_profile_header.html.twig' %}

    <div class="wrapper-container">
        {% if selectorData.selectedCharacter %}
            <!-- Header avec nom du personnage -->
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="page-title mb-2">
                        Analytics - {{ selectorData.selectedCharacter.name }}
                    </h2>
                    <p class="text-gray-400">{{ selectorData.selectedCharacter.server.name }} ‚Ä¢ Analyse d√©taill√©e de performance</p>
                </div>
            </div>

            {% if characterStats %}
                <!-- Contenu principal -->
                <div class="space-y-8">

                    <!-- ========== VUE D'ENSEMBLE FINANCI√àRE ========== -->
                    <div class="bg-gray-800/50 border border-gray-600/50 rounded-lg p-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
                                <span class="text-xl">üí∞</span>
                            </div>
                            <div>
                                <h2 class="text-white font-medium text-lg">Vue d'ensemble financi√®re</h2>
                                <p class="text-gray-400 text-sm">Aper√ßu de vos investissements et profits</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            {% include 'components/stats_card.html.twig' with {
                                title: 'Investissement Total',
                                value: characterStats.totalInvestment,
                                unit: 'kamas',
                                subtitle: 'Capital investi au total',
                                icon: 'üí∞',
                                color: 'purple'
                            } %}
                            {% include 'components/stats_card.html.twig' with {
                                title: 'Profit R√©alis√©',
                                value: characterStats.totalProfit,
                                unit: 'kamas',
                                subtitle: 'B√©n√©fice des ventes termin√©es',
                                icon: '‚úÖ',
                                color: characterStats.totalProfit >= 0 ? 'green' : 'red'
                            } %}
                            {% include 'components/stats_card.html.twig' with {
                                title: 'Profit Moyen',
                                value: characterStats.averageProfit,
                                unit: 'kamas',
                                subtitle: 'Par lot vendu',
                                icon: 'üìä',
                                color: 'cyan'
                            } %}
                            {% set roi = characterStats.totalInvestment > 0 ? (characterStats.totalProfit / characterStats.totalInvestment * 100) : 0 %}
                            {% include 'components/stats_card.html.twig' with {
                                title: 'ROI Global',
                                value: roi|number_format(1),
                                unit: '%',
                                subtitle: 'Retour sur investissement',
                                icon: 'üíπ',
                                color: roi >= 20 ? 'green' : (roi >= 10 ? 'orange' : 'red')
                            } %}
                        </div>
                    </div>

                    <!-- ========== ACTIVIT√â DE TRADING ========== -->
                    <div class="bg-gray-800/50 border border-gray-600/50 rounded-lg p-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                                <span class="text-xl">üìä</span>
                            </div>
                            <div>
                                <h2 class="text-white font-medium text-lg">Activit√© de trading</h2>
                                <p class="text-gray-400 text-sm">Statistiques de vos lots et transactions</p>
                            </div>
                        </div>

                        <!-- M√©triques en grille comme les cartes de personnages -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                            <!-- Carte Lots -->
                            <div class="p-4 bg-gray-800/70 border border-gray-600/50 rounded-lg hover:bg-gray-700/50 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                                        <span class="text-xl">üì¶</span>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-white font-medium">Gestion des lots</h3>
                                        <div class="flex items-center space-x-2 text-xs mt-1">
                                            <span class="text-blue-400">üîÑ {{ characterStats.activeLots }}</span>
                                            <span class="text-green-400">‚úì {{ characterStats.soldLots }}</span>
                                            {% set totalLots = characterStats.activeLots + characterStats.soldLots %}
                                            {% set successRate = totalLots > 0 ? (characterStats.soldLots / totalLots * 100) : 0 %}
                                            <span class="text-{{ successRate >= 80 ? 'green' : (successRate >= 60 ? 'orange' : 'red') }}-400">üéØ {{ successRate|number_format(1) }}%</span>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-gray-400 text-sm mt-2">{{ characterStats.soldLots }}/{{ totalLots }} lots termin√©s</p>
                            </div>

                            <!-- Carte Transactions -->
                            <div class="p-4 bg-gray-800/70 border border-gray-600/50 rounded-lg hover:bg-gray-700/50 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-lg flex items-center justify-center">
                                        <span class="text-xl">üí∞</span>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-white font-medium">Ventes individuelles</h3>
                                        <div class="flex items-center space-x-2 text-xs mt-1">
                                            <span class="text-yellow-400">üí∞ {{ characterStats.totalTransactions }}</span>
                                            {% set transactionRate = (characterStats.activeLots + characterStats.soldLots) > 0 ? (characterStats.totalTransactions / (characterStats.totalTransactions + characterStats.activeLots) * 100) : 0 %}
                                            <span class="text-{{ transactionRate >= 80 ? 'green' : (transactionRate >= 60 ? 'orange' : 'red') }}-400">‚ö° {{ transactionRate|number_format(1) }}%</span>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-gray-400 text-sm mt-2">Ventes individuelles r√©alis√©es</p>
                            </div>

                            <!-- Guide explicatif compact -->
                            <div class="p-4 bg-gradient-to-br from-green-900/20 to-blue-900/20 border border-green-500/30 rounded-lg">
                                <div class="flex items-center space-x-3 mb-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-teal-500 rounded-lg flex items-center justify-center">
                                        <span class="text-xl">üí°</span>
                                    </div>
                                    <h3 class="text-white font-medium">Diff√©rence cl√©</h3>
                                </div>
                                <div class="space-y-2 text-xs">
                                    <div><span class="text-blue-400 font-semibold">üì¶ Lot :</span> <span class="text-gray-300">Groupe d'items identiques</span></div>
                                    <div><span class="text-yellow-400 font-semibold">üí∞ Transaction :</span> <span class="text-gray-300">Vente d'une partie du lot</span></div>
                                    <div class="text-emerald-300 text-xs mt-2 font-medium">Un lot peut g√©n√©rer plusieurs transactions</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ========== ANALYSE DE PERFORMANCE ========== -->
                    <div class="bg-gray-800/50 border border-gray-600/50 rounded-lg p-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-10 h-10 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-lg flex items-center justify-center">
                                <span class="text-xl">üèÜ</span>
                            </div>
                            <div>
                                <h2 class="text-white font-medium text-lg">Analyse de performance</h2>
                                <p class="text-gray-400 text-sm">Vos meilleurs et moins bons trades</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            {% if characterStats.bestTrade %}
                                <div class="p-4 bg-gray-800/70 border border-gray-600/50 rounded-lg hover:bg-gray-700/50 transition-colors">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center">
                                            <span class="text-xl">üèÜ</span>
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="text-white font-medium">Meilleur Trade</h3>
                                            <div class="flex items-center space-x-2 text-xs mt-1">
                                                <span class="text-green-400">üí∞ {{ (characterStats.bestTrade.profit/1000)|number_format(0) }}k</span>
                                                <span class="text-gray-400">üìÖ {{ characterStats.bestTrade.soldAt|date('d/m') }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-gray-400 text-sm mt-2">{{ characterStats.bestTrade.item }}</p>
                                </div>
                            {% else %}
                                <div class="p-4 bg-gray-800/70 border border-gray-600/50 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-gray-500 to-gray-600 rounded-lg flex items-center justify-center">
                                            <span class="text-xl">üèÜ</span>
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="text-white font-medium">Meilleur Trade</h3>
                                            <div class="text-xs mt-1">
                                                <span class="text-gray-500">Aucune vente</span>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-gray-400 text-sm mt-2">Commencez √† vendre pour voir vos records</p>
                                </div>
                            {% endif %}

                            {% if characterStats.worstTrade %}
                                <div class="p-4 bg-gray-800/70 border border-gray-600/50 rounded-lg hover:bg-gray-700/50 transition-colors">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-{{ characterStats.worstTrade.profit >= 0 ? 'orange' : 'red' }}-500 to-{{ characterStats.worstTrade.profit >= 0 ? 'orange' : 'red' }}-600 rounded-lg flex items-center justify-center">
                                            <span class="text-xl">üìâ</span>
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="text-white font-medium">Trade le moins rentable</h3>
                                            <div class="flex items-center space-x-2 text-xs mt-1">
                                                <span class="text-{{ characterStats.worstTrade.profit >= 0 ? 'orange' : 'red' }}-400">üí∞ {{ (characterStats.worstTrade.profit/1000)|number_format(0) }}k</span>
                                                <span class="text-gray-400">üìÖ {{ characterStats.worstTrade.soldAt|date('d/m') }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-gray-400 text-sm mt-2">{{ characterStats.worstTrade.item }}</p>
                                </div>
                            {% else %}
                                <div class="p-4 bg-gray-800/70 border border-gray-600/50 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-gray-500 to-gray-600 rounded-lg flex items-center justify-center">
                                            <span class="text-xl">üìâ</span>
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="text-white font-medium">Trade le moins rentable</h3>
                                            <div class="text-xs mt-1">
                                                <span class="text-gray-500">Aucune vente</span>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-gray-400 text-sm mt-2">Aucune vente enregistr√©e</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- ========== √âVOLUTION TEMPORELLE ========== -->
                    {% if characterStats.monthlyTrend|length > 0 %}
                        <div class="bg-gray-800/50 border border-gray-600/50 rounded-lg p-6">
                            <div class="flex items-center space-x-3 mb-6">
                                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-teal-500 rounded-lg flex items-center justify-center">
                                    <span class="text-xl">üìà</span>
                                </div>
                                <div>
                                    <h2 class="text-white font-medium text-lg">√âvolution sur 6 mois</h2>
                                    <p class="text-gray-400 text-sm">Suivi de vos profits mensuels</p>
                                </div>
                            </div>

                            <!-- Grille mensuelle comme cartes de personnages -->
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                {% for month in characterStats.monthlyTrend %}
                                    <div class="p-4 bg-gray-800/70 border border-gray-600/50 rounded-lg hover:bg-gray-700/50 transition-colors text-center">
                                        <div class="text-white font-medium mb-2">{{ month.month }}</div>
                                        <div class="text-{{ month.profit >= 0 ? 'green' : 'red' }}-400 font-bold text-lg mb-1">
                                            {{ (month.profit/1000000)|number_format(1) }}M
                                        </div>
                                        <div class="text-gray-400 text-xs">
                                            {{ month.profit >= 0 ? '+' : '' }}{{ (month.profit/1000)|number_format(0) }}k
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- Analyse de tendance -->
                            {% if characterStats.monthlyTrend|length > 1 %}
                                {% set lastMonth = characterStats.monthlyTrend|last %}
                                {% set prevMonth = characterStats.monthlyTrend[characterStats.monthlyTrend|length - 2] %}
                                {% set trend = lastMonth.profit - prevMonth.profit %}
                                <div class="mt-6 p-4 bg-gray-800/40 border border-gray-600/30 rounded-lg">
                                    <div class="flex items-center justify-center gap-3">
                                        {% if trend > 0 %}
                                            <span class="text-green-400 text-lg">üìà</span>
                                            <span class="text-green-400 font-medium">Tendance positive :</span>
                                            <span class="text-green-300 font-bold">+{{ (trend/1000)|number_format(0) }}k vs mois dernier</span>
                                        {% elseif trend < 0 %}
                                            <span class="text-red-400 text-lg">üìâ</span>
                                            <span class="text-red-400 font-medium">Tendance n√©gative :</span>
                                            <span class="text-red-300 font-bold">{{ (trend/1000)|number_format(0) }}k vs mois dernier</span>
                                        {% else %}
                                            <span class="text-gray-400 text-lg">‚û°Ô∏è</span>
                                            <span class="text-gray-400 font-medium">Stabilit√© :</span>
                                            <span class="text-gray-300">Performance identique</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>

            {% else %}
                <!-- Pas de donn√©es pour ce personnage -->
                {% include 'components/empty_state.html.twig' with {
                    type: 'no_data',
                    title: 'Aucune donn√©e pour ' ~ selectorData.selectedCharacter.name,
                    message: 'Ce personnage n\'a pas encore de lots enregistr√©s.',
                    action: {
                        url: path('app_lot_new'),
                        text: 'Cr√©er le premier lot',
                        icon: 'üì¶'
                    }
                } %}
            {% endif %}

        {% else %}
            <!-- Aucun personnage s√©lectionn√© -->
            {% include 'components/empty_state.html.twig' with {
                type: 'no_character',
                title: 'Aucun personnage s√©lectionn√©',
                message: 'S√©lectionnez un personnage pour voir ses statistiques d√©taill√©es.',
                action: {
                    url: path('app_profile_index'),
                    text: 'G√©rer les personnages',
                    icon: 'üë•'
                }
            } %}
        {% endif %}
    </div>

{% endblock %}