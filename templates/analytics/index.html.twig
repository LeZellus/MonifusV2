{% extends 'base.html.twig' %}

{% block title %}Analytics Trading{% endblock %}

{% block body %}

{% include 'components/profile_selector.html.twig' %}

    <div class="wrapper-container">
        {% if stats and (selectedCharacter or stats.global.totalLots > 0) %}
            <div class="grid gap-4">
                <!-- Statistiques principales -->
                <div class="grid md:grid-cols-2 md:grid-cols-2 gap-4">
                    {% include 'components/stats_card.html.twig' with {
                        title: 'Investi',
                        value: stats.global.investedAmount,
                        unit: 'kamas',
                        subtitle: stats.global.availableLots ~ ' lots disponibles',
                        icon: 'üí∞',
                        color: 'orange'
                    } %}
                    {% include 'components/stats_card.html.twig' with {
                        title: 'Profit R√©alis√©',
                        value: stats.global.realizedProfit,
                        unit: 'kamas',
                        subtitle: stats.global.soldLots ~ ' lots vendus',
                        icon: '‚úÖ',
                        color: 'green'
                    } %}
                    {% include 'components/stats_card.html.twig' with {
                        title: 'Profit Potentiel',
                        value: stats.global.potentialProfit,
                        unit: 'kamas',
                        subtitle: 'Si tout vendu au prix cible',
                        icon: 'üéØ',
                        color: 'blue'
                    } %}
                    {% include 'components/stats_card.html.twig' with {
                        title: 'Total Lots',
                        value: stats.global.totalLots,
                        subtitle: stats.charactersCount ~ ' personnages',
                        icon: 'üìä',
                        color: 'purple'
                    } %}
                </div>

                <!-- M√©triques avanc√©es -->
                {% if stats.global.totalLots > 0 %}
                    <div class="grid md:grid-cols-2 md:grid-cols-2 gap-4">
                        {% include 'components/stats_card.html.twig' with {
                            title: 'Taux de vente',
                            value: ((stats.global.soldLots / stats.global.totalLots) * 100)|number_format(1),
                            unit: '%',
                            subtitle: stats.global.soldLots ~ ' / ' ~ stats.global.totalLots,
                            icon: 'üìà',
                            color: 'blue'
                        } %}
                        
                        {% set totalProfit = stats.global.realizedProfit + stats.global.potentialProfit %}
                        {% set roi = stats.global.investedAmount > 0 ? (totalProfit / stats.global.investedAmount * 100) : 0 %}
                        {% include 'components/stats_card.html.twig' with {
                            title: 'ROI Total',
                            value: roi|number_format(1),
                            unit: '%',
                            subtitle: 'Retour sur investissement',
                            icon: 'üíπ',
                            color: roi >= 20 ? 'green' : (roi >= 5 ? 'orange' : 'red')
                        } %}
                        
                        {% set avgProfitPerLot = stats.global.soldLots > 0 ? (stats.global.realizedProfit / stats.global.soldLots) : 0 %}
                        {% include 'components/stats_card.html.twig' with {
                            title: 'Profit moyen/lot',
                            value: avgProfitPerLot,
                            unit: 'kamas',
                            subtitle: 'Par lot vendu',
                            icon: 'üíé',
                            color: 'green'
                        } %}
                        
                        {% include 'components/stats_card.html.twig' with {
                            title: 'Lots par personnage',
                            value: (stats.global.totalLots / stats.charactersCount)|number_format(1),
                            subtitle: 'R√©partition moyenne',
                            icon: '‚öñÔ∏è',
                            color: 'purple'
                        } %}
                    </div>
                {% endif %}
            </div>

            <!-- Performance temporelle (si disponible) -->
            {% if stats.weeklyData is defined %}
                {% set weekly_content %}
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {% include 'components/stats_card.html.twig' with {
                            title: 'Cette semaine',
                            value: stats.weeklyData.profit,
                            unit: 'kamas',
                            subtitle: stats.weeklyData.sales ~ ' ventes',
                            icon: 'üìÖ',
                            color: 'blue'
                        } %}
                        {% include 'components/stats_card.html.twig' with {
                            title: 'Ce mois',
                            value: stats.monthlyData.profit,
                            unit: 'kamas',
                            subtitle: stats.monthlyData.sales ~ ' ventes',
                            icon: 'üìÜ',
                            color: 'green'
                        } %}
                        {% include 'components/stats_card.html.twig' with {
                            title: 'Meilleur jour',
                            value: stats.bestDay.profit,
                            unit: 'kamas',
                            subtitle: stats.bestDay.date|date('d/m'),
                            icon: 'üèÜ',
                            color: 'yellow'
                        } %}
                        {% include 'components/stats_card.html.twig' with {
                            title: 'Trend 7j',
                            value: stats.weekTrend|number_format(1),
                            unit: '%',
                            subtitle: 'vs semaine pr√©c√©dente',
                            icon: stats.weekTrend > 0 ? 'üìà' : 'üìâ',
                            color: stats.weekTrend > 0 ? 'green' : 'red'
                        } %}
                    </div>
                {% endset %}

                {% include 'components/form_section.html.twig' with {
                    title: 'Performance temporelle',
                    icon: '‚è±Ô∏è',
                    color: 'blue',
                    content: weekly_content
                } %}
            {% endif %}

            <!-- Analyse par serveur/personnage -->
            {% if stats.characterBreakdown is defined %}
                {% set character_content %}
                    <div class="space-y-3">
                        {% for char in stats.characterBreakdown %}
                            <div class="flex justify-between items-center p-4 bg-gray-700 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <img src="/classes{{ asset(char.classe.imgUrl) }}" alt="{{ char.classe.name }}" class="w-8 h-8 rounded">
                                    <div>
                                        <div class="text-white font-medium">{{ char.name }}</div>
                                        <div class="text-gray-400 text-sm">{{ char.server }} ‚Ä¢ {{ char.activeLots }} lots actifs</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    {% include 'components/price_display.html.twig' with {
                                        price: char.totalProfit,
                                        color: 'green',
                                        size: 'normal'
                                    } %}
                                    <div class="text-gray-400 text-sm">ROI: {{ char.roi|number_format(1) }}%</div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endset %}

                {% include 'components/form_section.html.twig' with {
                    title: 'Performance par personnage',
                    icon: 'üë•',
                    color: 'purple',
                    content: character_content
                } %}
            {% endif %}

            <!-- Top items rentables -->
            {% if stats.topItems|length > 0 %}
                {% set top_items_content %}
                    <div class="space-y-3">
                        {% for item in stats.topItems %}
                            {% set profit = item.totalProfit %}
                            {% set avgProfitPerItem = item.lotsCount > 0 ? (profit / item.lotsCount) : 0 %}
                            <div class="flex justify-between items-center p-4 bg-gray-700 rounded-lg">
                                <div>
                                    <div class="text-white font-medium">{{ item.itemName }}</div>
                                    <div class="text-gray-400 text-sm">
                                        {{ item.lotsCount }} lots ‚Ä¢ 
                                        {% include 'components/price_display.html.twig' with {
                                            price: avgProfitPerItem,
                                            size: 'small',
                                            show_kamas: false
                                        } %}/lot
                                    </div>
                                </div>
                                <div class="text-right">
                                    {% include 'components/price_display.html.twig' with {
                                        price: profit,
                                        color: profit >= 0 ? 'green' : 'red',
                                        size: 'normal'
                                    } %}
                                    {% if item.roi is defined %}
                                        <div class="text-gray-400 text-sm">ROI: {{ item.roi|number_format(1) }}%</div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endset %}

                {% include 'components/form_section.html.twig' with {
                    title: 'Top Items Rentables',
                    icon: 'üèÜ',
                    color: 'green',
                    content: top_items_content
                } %}
            {% endif %}

            <!-- Statistiques de march√© et surveillance -->
            {% if stats.marketData is defined %}
                {% set market_content %}
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {% include 'components/stats_card.html.twig' with {
                            title: 'Items surveill√©s',
                            value: stats.marketData.watchedItems,
                            subtitle: 'En observation',
                            icon: 'üëÅÔ∏è',
                            color: 'blue'
                        } %}
                        {% include 'components/stats_card.html.twig' with {
                            title: 'Surveillances actives',
                            value: stats.marketData.activeWatches,
                            subtitle: 'En cours',
                            icon: 'üîÑ',
                            color: 'green'
                        } %}
                        {% include 'components/stats_card.html.twig' with {
                            title: 'Mises √† jour r√©centes',
                            value: stats.marketData.recentUpdates,
                            subtitle: 'Derni√®res heures',
                            icon: 'üÜï',
                            color: 'purple'
                        } %}
                        {% include 'components/stats_card.html.twig' with {
                            title: 'Opportunit√©s',
                            value: stats.marketData.opportunities,
                            subtitle: '√Ä saisir',
                            icon: 'üí°',
                            color: 'yellow'
                        } %}
                    </div>
                {% endset %}

                {% include 'components/form_section.html.twig' with {
                    title: 'Surveillance des march√©s',
                    icon: 'üìä',
                    color: 'yellow',
                    content: market_content
                } %}
            {% endif %}

        {% else %}
            <!-- Aucun personnage s√©lectionn√© ou pas de donn√©es -->
            {% include 'components/empty_state.html.twig' with {
                type: 'no_data',
                title: 'Aucune donn√©e disponible',
                message: selectedCharacter ? 'Aucun lot trouv√© pour ce personnage.' : 'S√©lectionnez un personnage pour voir ses statistiques.',
                action: selectedCharacter ? {
                    url: path('app_lot_new'),
                    text: 'Cr√©er le premier lot',
                    icon: 'üì¶'
                } : {
                    url: path('app_profile_index'),
                    text: 'G√©rer les personnages',
                    icon: 'üë•'
                }
            } %}
        {% endif %}
    </div>
{% endblock %}