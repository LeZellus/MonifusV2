{% extends 'base.html.twig' %}
{% from 'macros/ui_macros.html.twig' import button, wrapper_section %}

{% block title %}Historique des Ventes{% endblock %}

{% block body %}
{% set sales_headers = ['Date Vente', 'Item', 'Quantit√©', 'Prix Attendu', 'Prix R√©el', 'Profit Total', 'Performance', 'Notes', 'Actions'] %}

{% include 'components/compact_profile_header.html.twig' %}

    <div class="wrapper-container">
        {% if selectorData.selectedCharacter %}
            <!-- Statistiques des ventes -->
            <div class="stats-grid">
                {% include 'components/stats_card.html.twig' with {
                    title: 'Profit R√©alis√©',
                    value: (total_realized_profit / 1000000)|number_format(1) ~ 'M',
                    icon: 'üí∞',
                    color: 'green'
                } %}
                {% include 'components/stats_card.html.twig' with {
                    title: 'Profit Attendu',
                    value: (total_expected_profit / 1000000)|number_format(1) ~ 'M',
                    icon: 'üéØ',
                    color: 'blue'
                } %}
                {% include 'components/stats_card.html.twig' with {
                    title: 'Diff√©rence',
                    value: (profit_difference >= 0 ? '+' : '') ~ (profit_difference / 1000000)|number_format(1) ~ 'M',
                    icon: 'üìä',
                    color: profit_difference >= 0 ? 'green' : 'red'
                } %}
                {% include 'components/stats_card.html.twig' with {
                    title: 'Ventes Total',
                    value: sales|length,
                    icon: 'üìà',
                    color: 'purple'
                } %}
            </div>

            <!-- Filtres -->
            <div class="wrapper-background">
                {% include 'components/section_header.html.twig' with {
                    type: 'simple',
                    title: 'Filtres',
                    icon: 'üîç',
                    color: 'blue',
                    wrapper_class: ''
                } %}
                
                <form method="GET" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label class="form-label">P√©riode</label>
                        <select name="period" class="form-input">
                            <option value="7" {{ current_filters.period == '7' ? 'selected' : '' }}>7 derniers jours</option>
                            <option value="30" {{ current_filters.period == '30' ? 'selected' : '' }}>30 derniers jours</option>
                            <option value="90" {{ current_filters.period == '90' ? 'selected' : '' }}>3 derniers mois</option>
                            <option value="365" {{ current_filters.period == '365' ? 'selected' : '' }}>Derni√®re ann√©e</option>
                            <option value="all" {{ current_filters.period == 'all' ? 'selected' : '' }}>Toute la p√©riode</option>
                        </select>
                    </div>

                    <div class="action-group">
                        {{ button('Filtrer', type='submit') }}
                        {{ button('Reset', path('app_sales_history_index'), class='btn-secondary') }}
                    </div>
                </form>
            </div>

            <!-- En-t√™te et actions -->
            <div class="flex justify-between items-center">
                <h2 class="page-title">
                    Historique des Ventes - {{ selectorData.selectedCharacter.name }}
                </h2>
                {% if sales|length > 0 %}
                    {{ button('Exporter CSV', path('app_sales_history_export', app.request.query.all), class='btn-success', icon='üìä') }}
                {% endif %}
            </div>

            <!-- Tableau des ventes -->
            {% include 'components/data_table.html.twig' with {
                headers: sales_headers,
                rows: sales,
                row_template: 'sales_history/_table_row.html.twig',
                empty_message: 'Aucune vente enregistr√©e',
                empty_action: {
                    url: path('app_lot_index'),
                    text: 'Voir mes lots disponibles',
                    icon: 'üì¶'
                }
            } %}

        {% else %}
            <!-- Aucun personnage s√©lectionn√© -->
            {% include 'components/empty_state.html.twig' with {
                type: 'no_character',
                title: 'Aucun personnage s√©lectionn√©',
                message: 'S√©lectionnez un personnage pour voir son historique de ventes.',
                action: {
                    url: path('app_profile_index'),
                    text: 'G√©rer les personnages',
                    icon: 'üë•'
                }
            } %}
        {% endif %}
    </div>
{% endblock %}