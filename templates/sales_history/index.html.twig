{% extends 'base.html.twig' %}

{% block title %}Historique des Ventes{% endblock %}

{% block body %}
<div class="bg-gray-900 min-h-screen">
    <nav class="bg-gray-800 border-b border-gray-700">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <h1 class="text-white text-xl font-bold">Historique des Ventes</h1>
                <a href="{{ path('app_trading_dashboard') }}" class="text-blue-400 hover:text-blue-300">‚Üê Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- S√©lecteur de personnage -->
        {% include 'components/character_selector.html.twig' %}

        <!-- Statistiques des ventes -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-white text-lg font-semibold mb-2">üí∞ Profit R√©alis√©</h3>
                <p class="text-green-400 text-2xl font-bold">
                    {{ (total_realized_profit / 1000000)|number_format(1) }}M
                </p>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-white text-lg font-semibold mb-2">üéØ Profit Attendu</h3>
                <p class="text-blue-400 text-2xl font-bold">
                    {{ (total_expected_profit / 1000000)|number_format(1) }}M
                </p>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-white text-lg font-semibold mb-2">üìä Diff√©rence</h3>
                <p class="text-{{ profit_difference >= 0 ? 'green' : 'red' }}-400 text-2xl font-bold">
                    {{ profit_difference >= 0 ? '+' : '' }}{{ (profit_difference / 1000000)|number_format(1) }}M
                </p>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-white text-lg font-semibold mb-2">üìà Ventes Total</h3>
                <p class="text-purple-400 text-2xl font-bold">{{ sales|length }}</p>
            </div>
        </div>

        <!-- Filtres -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <form method="GET" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label class="block text-white font-medium mb-2">P√©riode</label>
                    <select name="period" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-md">
                        <option value="7" {{ current_filters.period == '7' ? 'selected' : '' }}>7 derniers jours</option>
                        <option value="30" {{ current_filters.period == '30' ? 'selected' : '' }}>30 derniers jours</option>
                        <option value="90" {{ current_filters.period == '90' ? 'selected' : '' }}>3 derniers mois</option>
                        <option value="365" {{ current_filters.period == '365' ? 'selected' : '' }}>Derni√®re ann√©e</option>
                        <option value="all" {{ current_filters.period == 'all' ? 'selected' : '' }}>Toute la p√©riode</option>
                    </select>
                </div>

                <div class="flex space-x-2">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition-colors">
                        Filtrer
                    </button>
                    <a href="{{ path('app_sales_history_index') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md transition-colors">
                        Reset
                    </a>
                </div>
            </form>
        </div>

        <div class="flex justify-between items-center mb-6">
            <h2 class="text-white text-2xl font-bold">
                Historique des Ventes
                {% if selectedCharacter %}
                    - {{ selectedCharacter.name }}
                {% endif %}
            </h2>
            {% if sales|length > 0 %}
                <a href="{{ path('app_sales_history_export', app.request.query.all) }}" 
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                    üìä Exporter CSV
                </a>
            {% endif %}
        </div>

        {% if sales|length > 0 %}
            <div class="bg-gray-800 rounded-lg overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date Vente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Item</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Personnage</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Quantit√©</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Prix R√©el</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Prix Attendu</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Profit Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Performance</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Notes</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        {% for sale in sales %}
                            {% set lotGroup = sale.lotGroup %}
                            {% set quantitySold = sale.quantitySold %}
                            {% set realizedProfitPerLot = sale.actualSellPrice - lotGroup.buyPricePerLot %}
                            {% set realizedProfitTotal = realizedProfitPerLot * quantitySold %}
                            {% set expectedProfitPerLot = lotGroup.sellPricePerLot - lotGroup.buyPricePerLot %}
                            {% set expectedProfitTotal = expectedProfitPerLot * quantitySold %}
                            {% set performancePerLot = sale.actualSellPrice - lotGroup.sellPricePerLot %}
                            {% set performanceTotal = performancePerLot * quantitySold %}
                            {% set profitPercent = lotGroup.buyPricePerLot > 0 ? (realizedProfitPerLot / lotGroup.buyPricePerLot * 100) : 0 %}
                            
                            <tr class="hover:bg-gray-700">
                                <td class="px-6 py-4 whitespace-nowrap text-white text-sm">
                                    {{ sale.soldAt|date('d/m/Y H:i') }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-white font-medium">{{ lotGroup.item.name }}</div>
                                    <div class="text-gray-400 text-sm">Niv.{{ lotGroup.item.level }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-white">{{ lotGroup.dofusCharacter.name }}</div>
                                    <div class="text-gray-400 text-sm">{{ lotGroup.dofusCharacter.server.name }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-white font-medium">{{ quantitySold }} lots</div>
                                    <div class="text-gray-400 text-sm">par {{ lotGroup.saleUnit.value }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-white font-medium">{{ (sale.actualSellPrice / 1000)|number_format(0, ',', ' ') }}k</div>
                                    <div class="text-gray-400 text-sm">par lot</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-gray-300">{{ (lotGroup.sellPricePerLot / 1000)|number_format(0, ',', ' ') }}k</div>
                                    <div class="text-gray-400 text-sm">par lot</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-{{ realizedProfitTotal >= 0 ? 'green' : 'red' }}-400 font-medium">
                                        {{ (realizedProfitTotal / 1000)|number_format(0, ',', ' ') }}k
                                    </div>
                                    <div class="text-{{ realizedProfitTotal >= 0 ? 'green' : 'red' }}-400 text-sm">
                                        ({{ profitPercent|number_format(1) }}%)
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if performanceTotal == 0 %}
                                        <span class="px-2 py-1 text-xs rounded-full bg-gray-600 text-gray-300">
                                            Conforme
                                        </span>
                                    {% elseif performanceTotal > 0 %}
                                        <span class="px-2 py-1 text-xs rounded-full bg-green-600 text-green-100">
                                            +{{ (performanceTotal / 1000)|number_format(0, ',', ' ') }}k
                                        </span>
                                    {% else %}
                                        <span class="px-2 py-1 text-xs rounded-full bg-red-600 text-red-100">
                                            {{ (performanceTotal / 1000)|number_format(0, ',', ' ') }}k
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 text-gray-300 max-w-xs">
                                    {% if sale.notes %}
                                        <div class="truncate" title="{{ sale.notes }}">
                                            {{ sale.notes|slice(0, 30) }}{{ sale.notes|length > 30 ? '...' : '' }}
                                        </div>
                                    {% else %}
                                        <span class="text-gray-500">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-12">
                <p class="text-gray-400 text-lg mb-4">Aucune vente enregistr√©e pour le moment</p>
                <a href="{{ path('app_lot_index') }}" 
                   class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors">
                    Voir mes lots disponibles
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}