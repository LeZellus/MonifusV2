{% extends 'base.html.twig' %}
{% from 'macros/ui_macros.html.twig' import button, wrapper_section %}

{% block title %}Historique des Ventes{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('vendor/datatables.net-dt/css/dataTables.dataTables.min.css') }}">
{% endblock %}

{% block body %}
{% include 'components/compact_profile_header.html.twig' %}

    <div class="wrapper-container">
        {% if selectorData.selectedCharacter %}
            <!-- Statistiques des ventes (gardÃ©es pour la compatibilitÃ©) -->
            <div class="stats-grid">
                {% include 'components/stats_card.html.twig' with {
                    title: 'Profit RÃ©alisÃ©',
                    value: (total_realized_profit / 1000000)|number_format(1) ~ 'M',
                    icon: 'ðŸ’°',
                    color: 'green'
                } %}
                {% include 'components/stats_card.html.twig' with {
                    title: 'Profit Attendu',
                    value: (total_expected_profit / 1000000)|number_format(1) ~ 'M',
                    icon: 'ðŸŽ¯',
                    color: 'blue'
                } %}
                {% include 'components/stats_card.html.twig' with {
                    title: 'DiffÃ©rence',
                    value: (profit_difference >= 0 ? '+' : '') ~ (profit_difference / 1000000)|number_format(1) ~ 'M',
                    icon: 'ðŸ“Š',
                    color: profit_difference >= 0 ? 'green' : 'red'
                } %}
                {% include 'components/stats_card.html.twig' with {
                    title: 'PÃ©riode Active',
                    value: current_filters.period ~ ' jours',
                    icon: 'ðŸ“…',
                    color: 'purple'
                } %}
            </div>


            <!-- En-tÃªte et actions -->
            <div class="flex justify-between items-center">
                <h2 class="page-title">
                    Historique des Ventes - {{ selectorData.selectedCharacter.name }}
                </h2>
                {{ button('Exporter CSV', path('app_sales_history_export', current_filters), class='btn-success', icon='ðŸ“Š') }}
            </div>

            <!-- DataTable avec style cohÃ©rent -->
            <div class="hidden md:block bg-gray-800 rounded-lg overflow-hidden">
                <div data-controller="datatable"
                     data-datatable-ajax-url-value="{{ path('app_sales_history_datatable', current_filters) }}"
                     data-datatable-columns-value="{{ columns_config|json_encode|e('html_attr') }}"
                     data-datatable-page-length-value="25">

                    <table data-datatable-target="table" class="w-full" id="sales-history-table">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="table-header">Date Vente</th>
                                <th class="table-header">Item</th>
                                <th class="table-header">QuantitÃ©</th>
                                <th class="table-header">Prix Attendu</th>
                                <th class="table-header">Prix RÃ©el</th>
                                <th class="table-header">Profit Total</th>
                                <th class="table-header">Performance</th>
                                <th class="table-header">Notes</th>
                                <th class="table-header">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            <!-- Rempli dynamiquement par DataTables -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Vue mobile simplifiÃ©e -->
            <div class="md:hidden">
                <div class="text-center py-8 text-gray-400">
                    <p>La vue DataTables n'est disponible que sur desktop.</p>
                    <p class="mt-2">
                        <a href="{{ path('app_sales_history_export', current_filters) }}" class="text-blue-400 hover:text-blue-300">
                            TÃ©lÃ©charger en CSV
                        </a>
                    </p>
                </div>
            </div>

        {% else %}
            <!-- Aucun personnage sÃ©lectionnÃ© -->
            {% include 'components/empty_state.html.twig' with {
                type: 'no_character',
                title: 'Aucun personnage sÃ©lectionnÃ©',
                message: 'SÃ©lectionnez un personnage pour voir son historique de ventes.',
                action: {
                    url: path('app_profile_index'),
                    text: 'GÃ©rer les personnages',
                    icon: 'ðŸ‘¥'
                }
            } %}
        {% endif %}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        // Listener pour les Ã©vÃ©nements DataTable
        document.addEventListener('datatable:initialized', function(event) {
            console.log('âœ… DataTable Sales History initialisÃ©');
        });
    </script>
{% endblock %}