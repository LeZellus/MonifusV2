{% extends 'base.html.twig' %}

{% block title %}Vendre le lot - {{ lot_group.item.name }}{% endblock %}

{% block body %}
<div class="bg-gray-900 min-h-screen">
    <nav class="bg-gray-800 border-b border-gray-700">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <h1 class="text-white text-xl font-bold">Vendre le lot - {{ lot_group.item.name }}</h1>
                <a href="{{ path('app_lot_index') }}" class="text-blue-400 hover:text-blue-300">‚Üê Retour</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto">
            <!-- Informations du lot -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-white text-xl font-semibold mb-4">üì¶ Informations du lot</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <div class="text-gray-400 text-sm">Item</div>
                        <div class="text-white font-medium">{{ lot_group.item.name }}</div>
                        <div class="text-gray-400 text-sm">Niv.{{ lot_group.item.level }}</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-sm">Personnage</div>
                        <div class="text-white font-medium">{{ lot_group.dofusCharacter.name }}</div>
                        <div class="text-gray-400 text-sm">{{ lot_group.dofusCharacter.server.name }}</div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-sm">Configuration</div>
                        <div class="text-white font-medium">{{ lot_group.lotSize }} lots</div>
                        <div class="text-gray-400 text-sm">
                            Vente par {{ lot_group.saleUnit.value }}
                            {% if lot_group.saleUnit.value == 1 %}
                                (unit√©)
                            {% elseif lot_group.saleUnit.value == 10 %}
                                (x10)
                            {% else %}
                                (x100)
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <div class="text-gray-400 text-sm">Prix pr√©vu</div>
                        <div class="text-white font-medium">{{ (lot_group.sellPricePerLot / 1000)|number_format(0, ',', ' ') }}k</div>
                        <div class="text-gray-400 text-sm">par lot de {{ lot_group.saleUnit.value }}</div>
                    </div>
                </div>

                <!-- Calcul du profit pr√©vu -->
                {% set profitPrevu = lot_group.sellPricePerLot - lot_group.buyPricePerLot %}
                {% set profitPrevuPercent = lot_group.buyPricePerLot > 0 ? (profitPrevu / lot_group.buyPricePerLot * 100) : 0 %}
                <div class="mt-4 p-4 bg-gray-700 rounded-lg">
                    <div class="text-gray-400 text-sm mb-2">üí∞ Profit pr√©vu par lot</div>
                    <div class="flex justify-between items-center">
                        <div class="text-{{ profitPrevu >= 0 ? 'green' : 'red' }}-400 text-lg font-bold">
                            {{ (profitPrevu / 1000)|number_format(0, ',', ' ') }}k
                        </div>
                        <div class="text-{{ profitPrevu >= 0 ? 'green' : 'red' }}-400 text-sm">
                            ({{ profitPrevuPercent|number_format(1) }}%)
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulaire de vente -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-white text-xl font-semibold mb-4">üí∏ Enregistrer la vente</h2>
                {{ form_start(form) }}
                
                <div class="mb-4">
                    {{ form_label(form.actualSellPrice, null, {'label_attr': {'class': 'block text-white font-medium mb-2'}}) }}
                    {{ form_widget(form.actualSellPrice) }}
                    {{ form_errors(form.actualSellPrice) }}
                    <div class="text-gray-400 text-sm mt-1">
                        Prix pr√©vu : {{ (lot_group.sellPricePerLot / 1000)|number_format(0, ',', ' ') }}k
                    </div>
                </div>

                <div class="mb-6">
                    {{ form_label(form.notes, null, {'label_attr': {'class': 'block text-white font-medium mb-2'}}) }}
                    {{ form_widget(form.notes) }}
                    {{ form_errors(form.notes) }}
                    <div class="text-gray-400 text-sm mt-1">
                        Ex: "Vendu rapidement", "Prix du march√© plus bas", etc.
                    </div>
                </div>

                <!-- Aper√ßu du profit r√©el (JavaScript) -->
                <div id="profit-preview" class="mb-6 p-4 bg-gray-700 rounded-lg" style="display: none;">
                    <div class="text-gray-400 text-sm mb-2">üìä Profit r√©el calcul√©</div>
                    <div class="flex justify-between items-center">
                        <div id="profit-amount" class="text-lg font-bold"></div>
                        <div id="profit-percent" class="text-sm"></div>
                    </div>
                    <div id="profit-difference" class="text-sm mt-1"></div>
                </div>

                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded transition-colors">
                        ‚úÖ Confirmer la vente
                    </button>
                    <a href="{{ path('app_lot_index') }}" 
                       class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded transition-colors text-center">
                        Annuler
                    </a>
                </div>

                {{ form_end(form) }}
            </div>
        </div>
    </div>
</div>

<script>
// Calcul du profit en temps r√©el
document.addEventListener('DOMContentLoaded', function() {
    const priceInput = document.getElementById('lot_unit_actualSellPrice');
    const profitPreview = document.getElementById('profit-preview');
    const profitAmount = document.getElementById('profit-amount');
    const profitPercent = document.getElementById('profit-percent');
    const profitDifference = document.getElementById('profit-difference');
    
    const buyPrice = {{ lot_group.buyPricePerLot }};
    const expectedSellPrice = {{ lot_group.sellPricePerLot }};
    const expectedProfit = expectedSellPrice - buyPrice;
    
    function updateProfit() {
        const actualPrice = parseInt(priceInput.value) || 0;
        const actualProfit = actualPrice - buyPrice;
        const profitPercent = buyPrice > 0 ? (actualProfit / buyPrice * 100) : 0;
        const difference = actualProfit - expectedProfit;
        
        if (actualPrice > 0) {
            profitPreview.style.display = 'block';
            
            // Couleur selon le profit
            const color = actualProfit >= 0 ? 'text-green-400' : 'text-red-400';
            profitAmount.className = `text-lg font-bold ${color}`;
            profitPercent.className = `text-sm ${color}`;
            
            profitAmount.textContent = `${(actualProfit / 1000).toLocaleString()}k`;
            profitPercent.textContent = `(${profitPercent.toFixed(1)}%)`;
            
            // Diff√©rence avec le profit pr√©vu
            if (difference !== 0) {
                const diffColor = difference >= 0 ? 'text-green-400' : 'text-red-400';
                const diffSign = difference >= 0 ? '+' : '';
                profitDifference.className = `text-sm mt-1 ${diffColor}`;
                profitDifference.textContent = `${diffSign}${(difference / 1000).toLocaleString()}k vs pr√©vu`;
            } else {
                profitDifference.textContent = 'Conforme au profit pr√©vu';
                profitDifference.className = 'text-sm mt-1 text-gray-400';
            }
        } else {
            profitPreview.style.display = 'none';
        }
    }
    
    priceInput.addEventListener('input', updateProfit);
    updateProfit(); // Calcul initial
});
</script>
{% endblock %}