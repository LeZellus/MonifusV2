<!-- templates/lot/_form.html.twig -->
<div class="max-w-2xl mx-auto grid gap-4">

    {% if is_edit %}
        <!-- Informations actuelles du lot -->
        <div class="wrapper-background">
            {% include 'components/section_header.html.twig' with {
                type: 'simple',
                title: 'Informations actuelles',
                icon: 'üìä',
                color: 'blue',
                wrapper_class: ''
            } %}
            
            <div class="stats-grid">
                <div class="price-card">
                    <div class="price-label">Quantit√©</div>
                    <div class="stats-value text-white">{{ lot.lotSize }}</div>
                    <div class="price-label">lots</div>
                </div>
                <div class="price-card">
                    <div class="price-label">Prix achat</div>
                    <div class="stats-value">{{ price(lot.buyPricePerLot, 'orange') }}</div>
                    <div class="price-label">par lot</div>
                </div>
                <div class="price-card">
                    <div class="price-label">Prix vente</div>
                    <div class="stats-value">{{ price(lot.sellPricePerLot, 'orange') }}</div>
                    <div class="price-label">par lot</div>
                </div>
                {{ financial_card('Profit total', lot, 'success') }}
            </div>
        </div>
    {% endif %}

    <!-- Formulaire principal -->
    <div class="wrapper-background" data-controller="centralized-calculator" data-centralized-calculator-mode-value="lot">
        {% include 'components/section_header.html.twig' with {
            type: 'form',
            title: is_edit ? 'Modifier les informations' : 'Informations du lot',
            icon: is_edit ? 'üîÑ' : 'üìù',
            color: 'blue',
            wrapper_class: ''
        } %}

        {{ form_start(form) }}
        
        <div class="form-grid">
            <!-- Item avec autocompl√©tion ou lecture seule -->
            {% if is_edit %}
                {% include 'components/autocomplete_field.html.twig' with {
                    form: form,
                    search_field: 'itemSearch',
                    hidden_field: 'item',
                    is_readonly: true,
                    current_item: lot.item,
                    label: 'Item s√©lectionn√©',
                    readonly_help: 'üí° L\'item ne peut pas √™tre modifi√© apr√®s cr√©ation'
                } %}
            {% else %}
                {% include 'components/autocomplete_field.html.twig' with {
                    form: form,
                    search_field: 'itemSearch', 
                    hidden_field: 'item',
                    api_url: path('api_items_search'),
                    label: 'Rechercher un item',
                    placeholder: 'Tapez pour rechercher un item...',
                    help_text: 'üîç Tapez pour rechercher et s√©lectionner un item'
                } %}
            {% endif %}

            <!-- Configuration du lot -->
            <div>
                {{ form_label(form.lotSize, null, {'label_attr': {'class': 'form-label'}}) }}
                <div class="relative">
                    {{ form_widget(form.lotSize, {'attr': {
                        'class': 'form-input-lg', 
                        'placeholder': 'ex: 100',
                        'data-centralized-calculator-target': 'lotSize',
                        'data-action': 'input->centralized-calculator#updateCalculations'
                    }}) }}
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                        <span class="text-gray-400 text-sm">lots</span>
                    </div>
                </div>
                {{ form_errors(form.lotSize) }}
                <div class="form-help">üìä Quantit√© totale √† trader</div>
            </div>

            <div>
                {{ form_label(form.saleUnit, null, {'label_attr': {'class': 'form-label'}}) }}
                {{ form_widget(form.saleUnit, {'attr': {'class': 'form-input-lg'}}) }}
                {{ form_errors(form.saleUnit) }}
                <div class="form-help">üéØ Comment vous vendez sur Dofus</div>
            </div>

            <!-- Prix -->
            <div>
                {{ form_label(form.buyPricePerLot, null, {'label_attr': {'class': 'form-label'}}) }}
                <div class="relative">
                    {{ form_widget(form.buyPricePerLot, {'attr': {
                        'class': 'form-input-lg form-input-danger', 
                        'placeholder': '1000',
                        'data-centralized-calculator-target': 'buyPrice',
                        'data-action': 'input->centralized-calculator#updateCalculations'
                    }}) }}
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                        <span class="text-gray-400 text-sm">kamas</span>
                    </div>
                </div>
                {{ form_errors(form.buyPricePerLot) }}
                <div class="form-help">üí∏ Prix pay√© pour acheter</div>
            </div>

            <div>
                {{ form_label(form.sellPricePerLot, null, {'label_attr': {'class': 'form-label'}}) }}
                <div class="relative">
                    {{ form_widget(form.sellPricePerLot, {'attr': {
                        'class': 'form-input-lg form-input-success', 
                        'placeholder': '1200',
                        'data-centralized-calculator-target': 'sellPrice',
                        'data-action': 'input->centralized-calculator#updateCalculations'
                    }}) }}
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                        <span class="text-gray-400 text-sm">kamas</span>
                    </div>
                    
                </div>
                {{ form_errors(form.sellPricePerLot) }}
                <div class="form-help">üí° Laisser vide si inconnu</div>
            </div>

            <!-- Statut -->
            <div class="md:col-span-2">
                {% include 'components/toggle_field.html.twig' with {
                    form_field: form.status,
                    label: 'Statut du lot',
                    on_label: 'Vendu',
                    off_label: 'Disponible', 
                    on_value: 'sold',
                    off_value: 'available',
                    help_text: is_edit ? 'Changez le statut si n√©cessaire' : 'Statut initial du lot'
                } %}
            </div>

            <div class="text-white text-xs">
                Valeur actuelle du statut : {{ form.status.vars.value }}
            </div>
        </div>

        <!-- Aper√ßu du profit -->
        {% set profit_content %}
            <div class="stats-grid-3 text-center">
                <div>
                    <div class="text-white font-medium">Investissement</div>
                    <div data-centralized-calculator-target="investment" class="text-red-400 font-bold">-</div>
                </div>
                <div>
                    <div class="text-white font-medium">Profit par lot</div>
                    <div data-centralized-calculator-target="profitPerLot" class="text-green-400 font-bold">-</div>
                </div>
                <div>
                    <div class="text-white font-medium">Profit total</div>
                    <div data-centralized-calculator-target="totalProfit" class="text-green-400 font-bold">-</div>
                </div>
            </div>
        {% endset %}

        <div class="mt-6">
            {% include 'components/info_box.html.twig' with {
                title: is_edit ? 'Nouveau calcul de profit' : 'Aper√ßu du profit',
                icon: 'üí°',
                color: 'blue',
                content: profit_content
            } %}
        </div>

        <!-- Actions -->
        <div class="mt-8">
            {% include 'components/action_buttons.html.twig' with {
                submit_text: is_edit ? 'Sauvegarder les modifications' : 'Cr√©er le lot',
                submit_icon: is_edit ? 'üíæ' : '‚úÖ',
                submit_color: is_edit ? 'primary' : 'success',
                cancel_url: path('app_lot_index'),
                cancel_icon: '‚ùå'
            } %}
        </div>

        {{ form_end(form) }}
    </div>
</div>